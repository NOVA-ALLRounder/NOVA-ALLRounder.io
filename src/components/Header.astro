---
import { t, getLocalizedPath, type Locale } from '../i18n/utils';

interface Props {
  lang?: Locale;
}
const { lang = 'ko' } = Astro.props;

const navItems = [
  { labelKey: 'nav.github', href: 'https://github.com/NOVA-ALLRounder/main', external: true },
  { labelKey: 'nav.docs', href: '/docs' },
  { labelKey: 'nav.enterprise', href: '/enterprise' },
  { labelKey: 'nav.product', href: '/product' },
  { labelKey: 'nav.pricing', href: '/pricing' },
  { labelKey: 'nav.contact', href: '/contact' },
];

const repo = process.env.GITHUB_REPOSITORY?.split('/')[1] ?? '';
const isUserSiteRepo = repo.endsWith('.github.io');
const basePath = process.env.GITHUB_ACTIONS === 'true'
  ? (isUserSiteRepo ? '/' : `/${repo}/`)
  : '/';
const currentPath = Astro.url.pathname;

const withBase = (url: string) => {
  if (
    url.startsWith('http://') ||
    url.startsWith('https://') ||
    url.startsWith('mailto:') ||
    url.startsWith('tel:') ||
    url.startsWith('#')
  ) {
    return url;
  }
  if (!url.startsWith('/')) return url;

  const clean = url.replace(/^\/+/, '');
  return clean ? `${basePath}${clean}` : basePath;
};

// For non-external nav items, prefix with /en/ if lang is 'en'
const localizeHref = (href: string, external?: boolean) => {
  if (external) return href;
  if (lang === 'en') {
    return withBase(`/en${href}`);
  }
  return withBase(href);
};

const stripTrailingSlash = (path: string) => (path.length > 1 && path.endsWith('/') ? path.slice(0, -1) : path);
const appPath = (() => {
  if (basePath !== '/' && currentPath.startsWith(basePath)) {
    return `/${currentPath.slice(basePath.length)}`;
  }
  return currentPath;
})();
const normalizedCurrentPath = stripTrailingSlash(appPath);
const isActive = (href: string) => {
  if (href.startsWith('http://') || href.startsWith('https://')) return false;
  const normalizedHref = stripTrailingSlash(href);
  // Strip /en/ prefix for comparison
  const comparePath = normalizedCurrentPath.replace(/^\/en(\/|$)/, '/');
  const compareHref = normalizedHref.replace(/^\/en(\/|$)/, '/');
  return comparePath === compareHref || (compareHref !== '/' && comparePath.startsWith(compareHref));
};

// Language switcher URLs
const switchToKo = getLocalizedPath(currentPath, 'ko', basePath);
const switchToEn = getLocalizedPath(currentPath, 'en', basePath);
---

<header
  class:list={[
    'fixed top-0 left-0 right-0 z-50 border-b backdrop-blur-md transition-all duration-300',
    'bg-[#0d0e11]/80 border-white/10',
  ]}
  role="banner"
>
  <nav
    class="w-full px-6 h-[76px] relative flex items-center"
    aria-label="Main Navigation"
  >
    <a
      href={localizeHref('/')}
      class="flex items-center leading-none tracking-[-0.045em] transition-opacity hover:opacity-80"
    >
      <span class="font-black text-[2rem] md:text-[2.35rem] text-neutral-400">NO</span>
      <span class="font-black text-[2rem] md:text-[2.35rem] text-[#a5b4fc]">VA</span>
    </a>

    <ul class="hidden lg:flex items-center gap-8 absolute left-1/2 -translate-x-1/2" role="list">
      {navItems.map((item) => (
        <li>
          <a
            href={localizeHref(item.href, item.external)}
            target={item.external ? '_blank' : undefined}
            rel={item.external ? 'noopener noreferrer' : undefined}
            class:list={[
              'py-2 text-[1.05rem] leading-none transition-colors',
              isActive(item.href)
                ? 'text-[#a5b4fc]'
                : 'text-neutral-400 hover:text-neutral-100',
            ]}
            aria-current={isActive(item.href) ? 'page' : undefined}
          >
            {t(lang, item.labelKey)}
          </a>
        </li>
      ))}
    </ul>

    <div class="hidden lg:flex items-center gap-4 ml-auto">
      <!-- Language Switcher -->
      <div class="relative" id="lang-switcher">
        <button
          id="lang-toggle"
          class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-md text-sm font-medium text-neutral-400 hover:text-neutral-100 hover:bg-white/5 transition-colors"
          aria-expanded="false"
          aria-haspopup="true"
          aria-label="Select language"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <circle cx="12" cy="12" r="10"/>
            <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
          </svg>
          <span>{lang === 'ko' ? '한국어' : 'English'}</span>
          <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div
          id="lang-dropdown"
          class="hidden absolute right-0 top-full mt-1 w-32 rounded-lg bg-[#171a20] border border-white/10 shadow-lg overflow-hidden"
          role="menu"
        >
          <a
            href={switchToKo}
            role="menuitem"
            class:list={[
              'block px-4 py-2.5 text-sm transition-colors',
              lang === 'ko'
                ? 'text-neutral-100 font-semibold bg-white/5'
                : 'text-neutral-400 hover:text-neutral-100 hover:bg-white/5',
            ]}
          >
            한국어
          </a>
          <a
            href={switchToEn}
            role="menuitem"
            class:list={[
              'block px-4 py-2.5 text-sm transition-colors',
              lang === 'en'
                ? 'text-neutral-100 font-semibold bg-white/5'
                : 'text-neutral-400 hover:text-neutral-100 hover:bg-white/5',
            ]}
          >
            English
          </a>
        </div>
      </div>

      <a
        href={localizeHref('/signin')}
        class:list={[
          'inline-flex items-center text-[1.02rem] leading-none text-neutral-400 hover:text-neutral-100 transition-colors',
        ]}
      >
        {t(lang, 'nav.signin')}
      </a>
      <a
        href={localizeHref('/signup')}
        class:list={[
          'inline-flex items-center px-4 py-2 rounded-lg bg-[#a5b4fc] text-[#111214] text-[1.05rem] font-semibold leading-none hover:bg-[#c7d2fe] transition-colors',
        ]}
      >
        {t(lang, 'nav.signup')}
      </a>
    </div>

    <button
      id="mobile-menu-toggle"
      class:list={[
        'lg:hidden ml-auto inline-flex items-center justify-center w-10 h-10 rounded-md transition-colors text-neutral-100 hover:bg-white/5',
      ]}
      aria-expanded="false"
      aria-controls="mobile-menu"
      aria-label="Open Menu"
    >
      <svg id="menu-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
      <svg id="close-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </nav>

  <div
    id="mobile-menu"
    class:list={[
      'lg:hidden hidden border-t backdrop-blur bg-[#0d0e11]/98 border-white/10',
    ]}
    role="navigation"
    aria-label="Mobile Navigation"
  >
    <ul class="px-6 py-4 space-y-1" role="list">
      {navItems.map((item) => (
        <li>
          <a
            href={localizeHref(item.href, item.external)}
            class:list={[
              'block px-4 py-3 rounded-md text-base font-medium transition-colors',
              isActive(item.href)
                ? 'text-[#a5b4fc] bg-white/5'
                : 'text-neutral-400 hover:text-neutral-100 hover:bg-white/5',
            ]}
            aria-current={isActive(item.href) ? 'page' : undefined}
            target={item.external ? '_blank' : undefined}
            rel={item.external ? 'noopener noreferrer' : undefined}
          >
            {t(lang, item.labelKey)}
          </a>
        </li>
      ))}
    </ul>
    <!-- Mobile language switcher -->
    <div class="px-6 pb-2 flex gap-2">
      <a
        href={switchToKo}
        class:list={[
          'flex-1 px-4 py-2.5 text-center text-sm font-medium rounded-md transition-colors',
          lang === 'ko'
            ? 'bg-white/10 text-neutral-100'
            : 'text-neutral-400 hover:bg-white/5',
        ]}
      >
        한국어
      </a>
      <a
        href={switchToEn}
        class:list={[
          'flex-1 px-4 py-2.5 text-center text-sm font-medium rounded-md transition-colors',
          lang === 'en'
            ? 'bg-white/10 text-neutral-100'
            : 'text-neutral-400 hover:bg-white/5',
        ]}
      >
        English
      </a>
    </div>
    <div class="px-6 pb-4 pt-2 border-t border-white/10 flex flex-col gap-2">
      <a
        href={localizeHref('/signin')}
        class:list={[
          'block px-4 py-3 text-center text-base font-medium rounded-md transition-colors',
          'text-neutral-400 hover:text-neutral-100 hover:bg-white/5',
        ]}
      >
        {t(lang, 'nav.signin')}
      </a>
      <a
        href={localizeHref('/signup')}
        class:list={[
          'block px-4 py-3 text-center text-base font-medium rounded-md transition-colors',
          'bg-[#a5b4fc] text-[#111214] hover:bg-[#c7d2fe]',
        ]}
      >
        {t(lang, 'nav.signup')}
      </a>
    </div>
  </div>
</header>

<div class="h-[76px]" aria-hidden="true"></div>

<script>
  // Language switcher dropdown
  const langToggle = document.getElementById('lang-toggle');
  const langDropdown = document.getElementById('lang-dropdown');

  langToggle?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = !langDropdown?.classList.contains('hidden');
    langDropdown?.classList.toggle('hidden');
    langToggle.setAttribute('aria-expanded', String(!isOpen));
  });

  document.addEventListener('click', () => {
    langDropdown?.classList.add('hidden');
    langToggle?.setAttribute('aria-expanded', 'false');
  });

  // Mobile menu toggle
  const toggle = document.getElementById('mobile-menu-toggle');
  const menu = document.getElementById('mobile-menu');
  const menuIcon = document.getElementById('menu-icon');
  const closeIcon = document.getElementById('close-icon');

  toggle?.addEventListener('click', () => {
    const isOpen = menu?.classList.contains('hidden') === false;
    menu?.classList.toggle('hidden');
    menuIcon?.classList.toggle('hidden');
    closeIcon?.classList.toggle('hidden');
    toggle.setAttribute('aria-expanded', String(!isOpen));
    toggle.setAttribute('aria-label', isOpen ? 'Open Menu' : 'Close Menu');
  });
</script>
